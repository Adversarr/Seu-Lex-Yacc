//
// Created by Yang Jerry on 2022/3/30.
//

#include "sly/AttrDict.h"
#include "sly/FaModel.h"
#include "sly/LrParser.h"
#include "sly/RegEx.h"
#include "sly/Stream2TokenPipe.h"
#include <sly/sly.h>

#include <iostream>
#include <sstream>
#include <vector>

using sly::core::type::AttrDict;
using sly::core::type::Production;
using sly::core::type::Token;
using sly::core::grammar::ParsingTable::CellTp;
using sly::core::grammar::ParsingTable::AutomataAction;

using namespace std;

int main() {
  // return 0;
  sly::utils::Log::SetLogLevel(sly::utils::Log::kWarning);
  // 定义文法
  // 1. 定义tokens
  auto add =
      Token::Terminator("+", 0, Token::Attr::kLeftAssociative);
  auto sub =
      Token::Terminator("-", 0, Token::Attr::kLeftAssociative);
  auto multi =
      Token::Terminator("*", 0, Token::Attr::kLeftAssociative);
  auto div =
      Token::Terminator("/", 0, //   注意要用 R"(....)" 把每一个lambda的实现写进去（我实在是想不到怎么用宏来避免这个丑陋的东西了。
//   先用这个print出来下面的表。
//   auto table = cfg.GetLrTable();
//   table.Print(cout);
  auto table = sly::core::grammar::ParsingTable(
    {{{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=3},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=4},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kShiftIn,.id=6},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kShiftIn,.id=5},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kAccept,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kShiftIn,.id=7},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=3},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kShiftIn,.id=8},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=3},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kReduce,.id=3},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=11},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=12},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=7},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=7},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=7},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=7},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kReduce,.id=7},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=3},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=4},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=3},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=4},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=3},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=4},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=3},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=4},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kShiftIn,.id=18},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=19},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kShiftIn,.id=17},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kShiftIn,.id=20},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=3},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kShiftIn,.id=21},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kReduce,.id=3},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=3},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=11},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=12},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=7},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=7},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=7},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kReduce,.id=7},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=7},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=1},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=1},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kReduce,.id=1},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=2},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=2},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kReduce,.id=2},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=4},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=4},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=4},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=4},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kReduce,.id=4},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=5},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=5},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=5},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=5},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kReduce,.id=5},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=11},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=12},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=11},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=12},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=6},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=6},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=6},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=6},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kReduce,.id=6},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=11},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=12},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=11},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=12},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kShiftIn,.id=18},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kShiftIn,.id=27},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kShiftIn,.id=17},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=1},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kReduce,.id=1},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=1},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=2},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kReduce,.id=2},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=2},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=4},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=4},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=4},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kReduce,.id=4},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=4},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=5},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=5},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=5},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kReduce,.id=5},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=5},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, {{Token("",Token::Type::kEpsilon,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("(",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("*",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=6},}},{Token("a",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},{Token("-",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=6},}},{Token("/",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=6},}},{Token(")",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kReduce,.id=6},}},{Token("+",Token::Type::kTerminator,0,Token::Attr::kLeftAssociative), {CellTp{.action = AutomataAction::kReduce,.id=6},}},{Token("EOF_FLAG",Token::Type::kTerminator,0,Token::Attr::kNone), {CellTp{.action = AutomataAction::kError,.id=0},}},}, }, 
    {{{Token("Fact",Token::Type::kNonTerminator,0,Token::Attr::kNone),{2,}},{Token("Expr",Token::Type::kNonTerminator,0,Token::Attr::kNone),{1,}},},{},{},{{Token("Fact",Token::Type::kNonTerminator,0,Token::Attr::kNone),{10,}},{Token("Expr",Token::Type::kNonTerminator,0,Token::Attr::kNone),{9,}},},{},{{Token("Fact",Token::Type::kNonTerminator,0,Token::Attr::kNone),{2,}},{Token("Expr",Token::Type::kNonTerminator,0,Token::Attr::kNone),{13,}},},{{Token("Fact",Token::Type::kNonTerminator,0,Token::Attr::kNone),{2,}},{Token("Expr",Token::Type::kNonTerminator,0,Token::Attr::kNone),{14,}},},{{Token("Fact",Token::Type::kNonTerminator,0,Token::Attr::kNone),{15,}},},{{Token("Fact",Token::Type::kNonTerminator,0,Token::Attr::kNone),{16,}},},{},{},{{Token("Fact",Token::Type::kNonTerminator,0,Token::Attr::kNone),{10,}},{Token("Expr",Token::Type::kNonTerminator,0,Token::Attr::kNone),{22,}},},{},{},{},{},{},{{Token("Fact",Token::Type::kNonTerminator,0,Token::Attr::kNone),{10,}},{Token("Expr",Token::Type::kNonTerminator,0,Token::Attr::kNone),{23,}},},{{Token("Fact",Token::Type::kNonTerminator,0,Token::Attr::kNone),{10,}},{Token("Expr",Token::Type::kNonTerminator,0,Token::Attr::kNone),{24,}},},{},{{Token("Fact",Token::Type::kNonTerminator,0,Token::Attr::kNone),{25,}},},{{Token("Fact",Token::Type::kNonTerminator,0,Token::Attr::kNone),{26,}},},{},{},{},{},{},{},}, 
    productions,Token("Expr",Token::Type::kNonTerminator,0,Token::Attr::kNone),
    Token("#LR augmented#",Token::Type::kNonTerminator,0,Token::Attr::kNone),
    Token("",Token::Type::kEpsilon,0,Token::Attr::kNone));

  sly::core::grammar::LrParser parser(table);

  // 定义词法 transition 和 state
  auto [transition, state] = sly::core::lexical::DfaModel::Merge(
      {re_add.GetDfaModel(), re_alpha.GetDfaModel(), re_div.GetDfaModel(),
       re_lb.GetDfaModel(), re_multi.GetDfaModel(), re_rb.GetDfaModel(),
       re_sub.GetDfaModel(), re_blank.GetDfaModel()});
  auto s2ppl = sly::runtime::Stream2TokenPipe(
      transition, state, {add, alpha, div, lb, multi, rb, sub, blank}, ending);

  string input_string /* = "(1+2)*3"*/;
  cout << "Input Expr: ";
  cin >> input_string;
  cout << "The Expr: " << input_string << endl;
  stringstream input_stream(input_string);
  vector<AttrDict> attributes;
  vector<Token> tokens;
  while (true) {
    auto token = s2ppl.Defer(input_stream);
    if (token == blank)
      continue;
    AttrDict ad;
    ad.Set("lval", s2ppl.buffer_);
    tokens.emplace_back(token);
    attributes.emplace_back(ad);
    if (token == ending)
      break;
  }
  parser.Parse(tokens, attributes);
  auto tree = parser.GetTree();
  cout << "\n\nBefore Annotate.: " << endl;
  tree.Print(std::cout);
  tree.Annotate();
  cout << "\n\nAfter Annotate:" << endl;
  tree.Print(std::cout);
  cout << "\n\nThe Expr: " << input_string << endl;
  cout << "Evaluated : " << tree.GetRootAttributes()[0].Get<int>("v") << endl;
  return 0;
}
